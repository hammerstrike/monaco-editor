<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
	<link type="text/css" rel="stylesheet" data-name="vs/editor/editor.main" href="vs/editor/editor.main.css" />
</head>

<body>
	<h2>Monaco Editor Sync Loading Sample</h2>
	<div id="container" style="width: 100%; height: 600px; border: 1px solid grey"></div>

	<button id="ButtonSave" type="button">Save</button>

	<script>
		const require = { paths: { vs: 'vs' } };
	</script>
	<script src="vs/loader.js"></script>
	<script src="vs/editor/editor.main.nls.js"></script>
	<script src="vs/editor/editor.main.js"></script>
	<script>
		const pythonCode = `class Person:
  def __init__(self, fname, lname):
    self.firstname = fname
    self.lastname = lname

  def printname(self):
    print(self.firstname, self.lastname)

#Use the Person class to create an object, and then execute the printname method:

x = Person("John", "Doe")
x.printname()`;

		const editor = monaco.editor.create(document.getElementById('container'), {
			value: pythonCode,
			language: 'python',
			theme: 'vs-dark',
			formatOnPaste: true,
			formatOnType: true
		});

		const btnSave = document.getElementById('ButtonSave');
		btnSave.addEventListener('click', function (event) {
			console.log(editor.getValue());
		})
	</script>

	<script>
		const snippets = [
			{
				label: "fk",
				kind: monaco.languages.CompletionItemKind.Snippet,
				insertText: "fk ${1:table_name}.${2:field}",
				insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
				documentation: "Foreign key to table field statement"
			}
		];

		const suggestionsHelper = [
			{
				"name": "Person",
				"type": "Scripting.IPerson",
				"children": [
					{
						"name": "Age()",
						"type": "Scripting.IAge",
						"children": [],
						"description": {
							"title": "interface Scripting.IAge",
							"summary": "\r\n Age\r\n"
						},
					},
					{
						"name": "AgeCalulate()",
						"type": "Scripting.IAge",
						"children": [],
						"description": {
							"title": "interface Scripting.IAge",
							"summary": "\r\n Age\r\n"
						},
					},
					{
						"name": "Greet(firstname, lastname)",
						"type": "Scripting.IGreet",
						"children": [],
						"description": {
							"title": "interface Scripting.IGreet",
							"summary": "\r\n Greet\r\n"
						},
					}
				],
				"description": {
					"title": "interface scripting.IPerson",
					"summary": "\r\n API Response\r\n"
				},
			}
		];

		monaco.languages.registerCompletionItemProvider('python', {
			triggerCharacters: ['.'],
			provideCompletionItems: function (model, position, context, token) {
				console.log(model, position, context.triggerKind, token);

				// parse the current suggestion position
				let suggestions = []
				const textUntilPosition = model.getValueInRange({ startLineNumber: position.lineNumber, startColumn: 1, endLineNumber: position.lineNumber, endColumn: position.column })
				const word = model.getWordUntilPosition(position)
				const range = {
					startLineNumber: position.lineNumber,
					endLineNumber: position.lineNumber,
					startColumn: word.startColumn,
					endColumn: word.endColumn
				}

				if (context.triggerKind === 1) {
					suggestionsHelper
						.forEach(item => {
							if (item.name.toLocaleLowerCase() === textUntilPosition.slice(0, -1).toLocaleLowerCase()) {
								suggestions = item.children;
							}
						})

					console.log(suggestions);
				} else {
					const objectHierarchy = textUntilPosition.split('.');
					suggestions = suggestionsHelper;
					if (objectHierarchy.length) {
						objectHierarchy.forEach(item => {
							suggestions = suggestions.find(suggestionItem => suggestionItem.name === item)?.children || suggestions;
						});
					}
				}

				console.log(textUntilPosition)
				console.log(word)
				console.log(range)


				// check for nested object
				// Return combined suggestions
				// return { suggestions: createSuggestions(suggestions) };

				return new Promise((resolve, reject) => {
					setTimeout(() => {
						resolve({ suggestions: createSuggestions(suggestions) });
					}, 2000);
				})
			}
		});


		function createSuggestions(suggestions) {
			return suggestions.map(function (item) {
				return {
					label: item.name,
					kind: monaco.languages.CompletionItemKind.Interface,
					insertText: item.name,
					insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
					documentation: item.description.title + item.description.summary
				}
			})
		}

	</script>
</body>

</html>